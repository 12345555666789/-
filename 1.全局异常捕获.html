<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>全局异常捕获</title>
    <script src="js/axios.js"></script>
</head>
<body>
<div style="font-size: 25px">捕获结果:<h3 id="syncCatch"></h3></div>
<div style="font-size: 25px">异步错误:<h3 id="asyncCatch"></h3></div>
<button id="errBtn">报错</button>
<script>

    (function () {
        // 记录点击
        let clickEvents = []
        document.addEventListener('click', function (e) {
            let path = []
            e.path.forEach((item) => {
                path.unshift({
                    nodeName: item.nodeName || 'WINDOW',
                    className: item.className || null,
                    id: item.id || null
                })
            })
            clickEvents.unshift({
                x: e.pageX,
                y: e.pageY,
                path: path
            })
            clickEvents.splice(30)
        })

        // 同步
        window.onerror = function (msg, fileUrl, lineNo, columnNo, error) { //最后两个参数有些部分浏览器拿不到,依然需要记录
            var stack = null;
            if (error && error.stack) stack = error.stack;
            var json = {
                msg: msg || null,
                path: fileUrl || null,
                lineNo: lineNo || null,
                columnNo: columnNo || null,
                error: stack,
                time: new Date().getTime(),
                clickEvents: clickEvents
            }
            sendError(json)
            // return true // 阻止报错向上传递
        }


        // 异步
        window.onunhandledrejection = function (event) {
            asyncCatch.innerText = event.reason
            sendError({promiseErr: event.reason})
        }

        // 上报异常
        window.sendError = function (json) {
            syncCatch.innerText = JSON.stringify(json)
            var userAgent = navigator.userAgent;
            if (XMLHttpRequest) {
                var xhr = new XMLHttpRequest()
                xhr.open('post', 'http://127.0.0.1:8888', true)
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded')
                xhr.send("message=" + JSON.stringify(json) + "&userAgent=" + encodeURIComponent(userAgent))
            }
        }
    })()

    // 同步错误
    // a.a = 10

    // 异步错误
    asyncError()
    function asyncError () {
        Promise.reject('泽鑫最帅~')
    }

    function errRun () {
        errRun()
    }
    errBtn.addEventListener('click', function () {
        errRun()
    })
</script>
</body>
</html>